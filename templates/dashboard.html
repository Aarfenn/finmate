{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h2>Witaj, {{ session['user_name'] }}!</h2>
  <div class="mb-3">
    <a href="{{ url_for('create_budget') }}" class="btn btn-primary me-2">Stwórz Budżet</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Wyloguj się</a>
  </div>
  <hr>

  <div class="row">
    <!-- Lewa kolumna: Kategorie tytuł-->
    <div class="col-md-6">
        <h4>
            {% if selected_budget %}
                Kategorie i wydatki dla {{ "%04d" | format(selected_budget.year) }}/{{ "%02d" | format(selected_budget.month) }}
            {% else %}
                Kategorie i wydatki
            {% endif %}
        </h4>


      <!-- Formularz dodania wydatku -->
      <form method="post" action="/add_expense" class="mb-4">
        <input type="hidden" name="budget_id" value="{{ selected_budget['id'] if selected_budget }}">
        <div class="mb-2">
          <select name="category" class="form-select" required>
            {% for cat in predefined_categories %}
              <option value="{{ cat.name }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <input type="number" name="amount" step="0.01" class="form-control" placeholder="Kwota" required>
        </div>
        <button class="btn btn-success">Dodaj wydatek</button>
      </form>

      <!-- Kategorie -->
      {% for c in category_data %}
        <div class="mb-3 p-2 border rounded" style="border-color: {{ c.color }};">
          <div class="d-flex justify-content-between">
            <strong>{{ c.name }}</strong>
            <div class="d-flex align-items-center gap-2">
              <span id="limit-display-{{ c.name }}" data-spent="{{ c.spent }}" data-limit="{{ c.limit }}">
                {{ c.spent }}/{{ c.limit }} zł
              </span>
              <a href="#" onclick="toggleLimitForm('{{ c.name }}')" class="gear-link" title="Ustaw limit">⚙️</a>
            </div>
            <div id="limit-form-{{ c.name }}" class="limit-form mt-2">
              <input id="limit-input-{{ c.name }}" type="number" step="0.01" class="form-control mb-1" placeholder="Nowy limit">
              <button type="button" class="btn btn-sm btn-primary" onclick="saveLimit({{ selected_budget['id'] }}, '{{ c.name }}')">Zapisz</button>
            </div>

          </div>
          <div class="progress mt-1" style="height: 20px; border-radius: 10px;">
            <div class="progress-bar" role="progressbar"
                style="
                  width: {{ (c.spent / c.limit * 100) if c.limit > 0 else 0 }}%;
                  background-color: {{ c.color }};
                  border-radius: 10px;
                ">
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Prawa kolumna: Historia budżetów -->
    <div class="col-md-6">
      <h4>Historia budżetów</h4>
      {% if budgets %}
        <table class="table table-striped mt-3">
        <thead>
        <tr>
            <th>Rok</th>
            <th>Miesiąc</th>
            <th>Dochód</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        {% for budget in budgets %}
            <tr>
            <td>{{ budget['year'] }}</td>
            <td>{{ budget['month'] }}</td>
            <td>{{ budget['income'] }} zł</td>
            <td>
                <a href="{{ url_for('dashboard_preview', budget_id=budget['id']) }}" class="btn btn-outline-primary btn-sm">Podgląd</a>
            </td>
            </tr>
        {% endfor %}
        </tbody>

        </table>
      {% else %}
        <p>Brak zapisanych budżetów.</p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
